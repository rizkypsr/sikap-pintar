services:
  app:
    build:
      context: .
      dockerfile: .docker/Dockerfile
    image: dpmpstp_v2-app:prod
    env_file:
      - .env
    ports:
      - "${APP_PORT:-8000}:8000"
    depends_on:
      - redis
      - minio
      - minio-init
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 6
    restart: unless-stopped
    volumes:
      - app-storage:/app/storage
      - app-bootstrap:/app/bootstrap/cache
    deploy:
      resources:
        limits:
          cpus: '${APP_CPUS:-1.0}'
          memory: '${APP_MEMORY:-512M}'
        reservations:
          cpus: '0.50'
          memory: '256M'

  mysql:
    image: mysql:8.0
    platform: ${DOCKER_PLATFORM:-linux/arm64/v8}
    profiles: ["mysql"]
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-laravel}
      MYSQL_USER: ${DB_USERNAME:-laravel}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
    ports:
      - "${FORWARD_DB_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-p${DB_PASSWORD:-secret}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  pgsql:
    image: postgres:15-alpine
    platform: ${DOCKER_PLATFORM:-linux/arm64/v8}
    profiles: ["pgsql"]
    environment:
      POSTGRES_DB: ${DB_DATABASE:-laravel}
      POSTGRES_USER: ${DB_USERNAME:-laravel}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
    ports:
      - "${FORWARD_PG_PORT:-5432}:5432"
    volumes:
      - pgsql-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-laravel}"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  redis:
    image: redis:7.2-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${FORWARD_REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    env_file:
      - .env
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "${FORWARD_MINIO_PORT:-9000}:9000"
      - "${FORWARD_MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 12
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    env_file:
      - .env
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      until mc alias set minio http://minio:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD; do
        sleep 1;
      done;
      mc mb -p minio/$MINIO_BUCKET || true;
      mc anonymous set download minio/$MINIO_BUCKET || true;
      "
    restart: "no"

volumes:
  app-storage:
  app-bootstrap:
  mysql-data:
  pgsql-data:
  redis-data:
  minio-data: